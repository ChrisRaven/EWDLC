// https://github.com/crazyman4865/EWDLC/blob/master/LICENSE
var EWDLC=function(e){"use strict";function t(e,t,n){var a=this,o=new Set,i=e,s=n,r=t;a.getName=function(){return i},a.getDefault=function(){return s},a.setDefault=function(e){s=e},a.registerCallback=function(e){e&&typeof e==typeof Function&&o.add(e)},a.unregisterCallback=function(e){o.delete(e)},a.getValue=function(){return r},a.setValue=function(e){r!==e&&(r=e,o.forEach(e=>e(i,r)))},a.reset=function(){a.setValue(s)}}function n(e){var n=this,a={},o="ewdlc-prefs",i=!1;function s(){let e={};for(let t in a)e[t]=a[t].getValue();localStorage.setItem(o,JSON.stringify(e))}n.registerSetting=function(e){e&&e instanceof t&&(a[e.getName()]=e,a[e.getName()].registerCallback(s))},n.getSetting=function(e){return a[e]},n.init=function(){i||($(document).trigger("ewdlc-preferences-loading"),function(){let e=localStorage.getItem(o);if(!e)return;let t=JSON.parse(e);for(let e in t){let a=n.getSetting(e);a&&a.setValue(t[e])}}(),$(document).trigger("ewdlc-preferences-loaded"),i=!0)}}function a(e){var t=e,n={},a=!1;this.getUsername=function(){return t},this.isScout=function(){return n.isScout},this.isScythe=function(){return n.isScythe},this.isMystic=function(){return n.isMystic},this.isModerator=function(){return n.isModerator},this.isMentor=function(){return n.isMentor},this.isAdmin=function(){return n.isAdmin},this.isReady=function(){return a},this.refreshInfo=function(){return new Promise((e,o)=>{let i="/1.0/player/";i+=t?t+"/bio":"describe",$.getJSON(i).done(o=>{!function(e){t=e.username;let a=e.roles;a.indexOf("admin")>=0&&(n.isAdmin=!0),(n.isAdmin||a.indexOf("scout")>=0)&&(n.isScout=!0),(n.isAdmin||a.indexOf("scythe")>=0)&&(n.isScythe=!0),(n.isAdmin||a.indexOf("mystic")>=0)&&(n.isMystic=!0),(n.isAdmin||a.indexOf("moderator")>=0)&&(n.isModerator=!0),(n.isAdmin||a.indexOf("mentor")>=0)&&(n.isMentor=!0)}(o),a=!0,e()}).fail(o)})}}function o(){var e;function n(){e=$("<div>").addClass("settings-group invisible"),$("<h1>").text("EyeWire DLC").appendTo(e),e.appendTo("#settingsMenu")}this.makeCheckbox=function(a,o){if(!(a&&a instanceof t&&o))return;e||n();let i=$("<div>").addClass("setting");$("<span>").text(o).appendTo(i);let s=$("<input>").attr("type","checkbox").hide().appendTo(i);s.prop("checked",!!a.getValue()),s.checkbox().each(function(){var e=$(this);a.getValue()?e.removeClass("off").addClass("on"):e.removeClass("on").addClass("off")}),s.change(function(e){e.stopPropagation();var t=$(this);a.setValue(t.is(":checked"))}),i.find(".checkbox").click(function(e){var t=s;t.prop("checked",!t.is(":checked")),t.change()}),i.click(function(e){e.stopPropagation();var t=s;t.prop("checked",!t.is(":checked")),t.change()});var r=e.find(".setting > .minimalButton").first();r.length>0?i.insertBefore(r.parent()):i.appendTo(e)},this.makeButton=function(t){if(!t)return;e||n();let a=$("<div>").addClass("setting"),o=$("<div>").addClass("minimalButton").text(t).appendTo(a);return a.appendTo(e),o}}var i={normal:0,frozen:10,stashed:6,duplicate:11};function s(e){var t=this,i=!1,s=e;t.preferences=new n(t),t.account=new a,t.modules={},t.settingsUi=new o,t.init=function(){i||(t.preferences.init(),t.account.refreshInfo().then(()=>$(document).trigger("ewdlc-account-ready")),i=!0)},t.getResourceUrl=function(e){return s+e}}function r(e){var t=(e=e||{}).name,n=e.prefix,a=e.scope,o=0,i=!1,s=$("<span>").text(t),r=$("<div>").addClass("chatTab").append(s).append($("<span>").css("margin-left","3px").addClass("sl-badge").text("0").hide()).append($("<i>").addClass("fa").addClass("fa-close").css("margin-left","3px").hide());this.getElement=function(){return r},this.getPrefix=function(){return n},this.getScope=function(){return a},this.getName=function(){return t},this.getUnread=function(){return o},this.isPMTab=function(){return n.startsWith("/pm")},this.isClosed=function(){return i},this.setName=function(e){t=e,r.text(name)},this.setActive=function(e){e?(o=0,r.addClass("active")):r.removeClass("active")},this.setUnread=function(e){if(!isNaN(e)&&e>=0){o=e;let t=r.children("span.sl-badge");t.text(o),o>0?t.show():t.hide()}},this.close=function(){r.removeClass("active").addClass("disabled"),r.css("margin-left",-r.outerWidth()+"px"),i=!0},this.open=function(){r.removeClass("disabled"),r.css("margin-left","0px"),i=!1},n.startsWith("/pm")&&(r.children("i").show(),$.get("/1.0/player/"+a+"/bio").done(function(e){$(".chatInput").val().startsWith(n)&&$(".chatInput").val("/pm "+e.username+" "+$(".chatInput").val().substring(n.length)),a=e.username,n="/pm "+e.username+" ",s.text(a)}))}function c(e){var n={"tc-show-timestamp":new t("tc-show-timestamp",!0),"tc-show-all-in-tabs":new t("tc-show-all-in-tabs",!0),"tc-show-points-msgs":new t("tc-show-points-msgs",!0),"tc-show-channels-in-all":new t("tc-show-channels-in-all",!0),"tc-enable-unread":new t("tc-enable-unread",!0),"tc-grayout-messages":new t("tc-grayout-messages",!1),"tc-show-leaderboard":new t("tc-show-leaderboard",!0),"tc-allow-backslash-prefix":new t("tc-allow-backslash-prefix",!0)},a=[{key:"tc-show-timestamp",lang:"Chat Timestamp"},{key:"tc-show-all-in-tabs",lang:"General Chat visible in all channels"},{key:"tc-show-channels-in-all",lang:"All channels visible in General Chat"},{key:"tc-show-points-msgs",lang:"Points messages"},{key:"tc-enable-unread",lang:"Unread messages counter"},{key:"tc-grayout-messages",lang:"Show all hidden messages as faded instead"},{key:"tc-show-leaderboard",lang:"Leaderboard pop-up after cube submission"},{key:"tc-allow-backslash-prefix",lang:"Allow backslash as command prefix"}];this.set=function(e,t){n[e].setValue(t)},this.get=function(e){return n[e].getValue()},$(document).on("ewdlc-preferences-loading.tabbedChat",function(){for(var t in n)ewdlc.preferences.registerSetting(n[t]),n[t].registerCallback(e)}),$(document).on("ewdlc-preferences-loaded.tabbedChat",function(){for(let e in a)ewdlc.settingsUi.makeCheckbox(n[a[e].key],a[e].lang)})}function l(e){var t={};function n(){tomni.chat.addMsg({},"An error was encountered while running this command. Please wait a moment and try again.")}function a(e){var t=tomni.cell,n=15;if(e.length>=2)if("this"===e[1].toLowerCase())t=tomni.cell;else if(t=parseInt(e[1]),isNaN(t)||t<=0)return{cellId:-1,limit:n};return e.length>=3&&(n=parseInt(e[2]),isNaN(n))?{cellId:-1,limit:n}:(n<=0&&(n=99999),{cellId:t,limit:n})}this.bind=function(e,n,a,o){t[e]={},t[e].description=n,t[e].usage=a,t[e].callback=o},this.unbind=function(e){t[e]&&delete t[e]},this.exec=function(e){if(!e)return!1;var n=e.split(" ");if(0===n.length)return!1;var a=t[n[0]];return!!a&&(a.callback(n),!0)},this.bind("/help","","",function(e){for(var n in tomni.chat.addMsg({},"------------------"),tomni.chat.addMsg({},"Tabbed Chat commands:"),t)if("/help"!==n){var a=t[n],o=n;(a.description||a.usage)&&(o+=": "),a.description&&(o+=a.description),a.description&&a.usage&&(o+=", Usage: "),a.usage&&(o+=a.usage),tomni.chat.addMsg({},o)}tomni.chat.addMsg({},"------------------")}),this.bind("/add-cell","Adds one or more cells to the overview","/add-cell Cell ID 1 [Cell ID 2] ...",function(e){for(var t=1;t<e.length;t++){var n=parseInt(e[t],10);isNaN(n)||tomni.threeD.addCell({cellid:n,center:!0})}}),this.bind("/size","Shows the size of the current cell","",function(e){var t=tomni.threeD.getCell(tomni.cell).info;tomni.chat.history.add(e[0]),$.get("/1.0/cell/"+tomni.cell+"/tasks").done(function(e){var n=e.tasks.filter(function(e){return e.status!=i.stashed});tomni.chat.addMsg({},t.name+" is "+n.length+" cube"+(1!==e.tasks.length?"s":"")+" big.")}).fail(n)}),this.bind("/guess","Submits your current coordinates as a hunt guess","",function(e){if(tomni.getCurrentCell().info.is_hunt){var t=tomni.center.rotation.clone().multiplyScalar(100).round().multiplyScalar(.01).floor(),n="/pm thehunt "+(t=(t=[t.x,t.y,t.z]).join(" "));tomni.chat.submitChatMessage(n)}else tomni.chat.addMsg({},"You must be in a hunt cell to use this command.")}),this.bind("/clear","Clears the chat","",function(e){$(".chatMsgContainer").empty(),tomni.chat.addMsg({},"The chat has been cleared.")}),ewdlc.account.isScout()&&this.bind("/dupe","Lists the duplicates in the current cube","",function(e){if(ewdlc.account.isScout())if(tomni.chat.history.add(e[0]),tomni.gameMode&&tomni.task.inspect)if(0!==tomni.task.duplicates.length){var t="Duplicates in the current cube:\n ";t+=tomni.task.duplicates.map(function(e){return"#"+e.task_id}).join(" "),tomni.chat.addMsg({},t)}else tomni.chat.addMsg({},"There are no duplicates in this cube.");else tomni.chat.addMsg({},"You must be inspecting a cube to use this command.");else tomni.chat.addMsg({},"You must be a scout or higher to use this command.")}),ewdlc.account.isScythe()&&(this.bind("/low-wt","Lists low weight cubes in cell","/low-wt [cell=this] [limit=15]",function(e){var t=function(e,t,n,a,o){var i=0,s=e,r="";if(o[n]&&o[n].length>0&&o[n].findIndex(function(e){return $.inArray(e.task_id,a)>=0})){r+="Weight "+n+":\n  ";for(var c=o[n].length-1;c>=0;c--)if(!($.inArray(o[n][c].task_id,a)>=0)){if(r+="#"+o[n][c].task_id,(e<t-1||0!==c)&&(r+="  "),i++,++e===t)break;4===i&&c>0&&(r+="\n ",i=0)}}return{msg:r,counter:e,any:s!=e}},o=function(){tomni.chat.addMsg({},"Usage: /low-wt [cell=this] [limit=15]")};if(ewdlc.account.isScout()){var i=a(e);if(i.cellId<0)o();else{var s=i.cellId,r=i.limit;e.length>3?o():(tomni.chat.history.add(e.join(" ")),$.get("/1.0/cell/"+s+"/heatmap/scythe").done(function(e){var a=e.frozen;$.get("/1.0/cell/"+s+"/heatmap/low-weight?weight=3").done(function(e){for(var n=0,o="Low weight cubes in cell "+s+" (limit "+r+"): ",i=0;i<3;i++){var c=t(n,r,i.toString(),a,e);if(c.any&&(o+="\n "),o+=c.msg,(n=c.counter)>=r)break}0===n?tomni.chat.addMsg({},"There are no low weight cubes in cell "+s):tomni.chat.addMsg({},o)}).fail(n)}).fail(n))}}else tomni.chat.addMsg({},"You must be a scout or higher to use this command.")}),this.bind("/sc-info","Shows count of the SC you've done, the amount you can do, and lists cube IDs with SC < 2, wt >= 3","/sc-info [cell=this] [limit=15]",function(e){var t=function(){tomni.chat.addMsg({},"Usage: /sc-info [cell=this] [limit=15]")},o=function(e,t){for(var n=0;n<t.length;n++){var a=e.indexOf(t[n]);a>=0&&e.splice(a,1)}return e};if(ewdlc.account.isScythe()){var s=a(e);if(s.cellId<0)t();else{var r=s.cellId,c=s.limit;e.length>3?t():(tomni.chat.history.add(e.join(" ")),tomni.chat.addMsg({},"Please wait while Grim's minions collect some data..."),$.when($.getJSON("/1.0/cell/"+r+"/tasks"),$.getJSON("/1.0/cell/"+r+"/heatmap/scythe"),$.getJSON("/1.0/cell/"+r+"/tasks/complete/player")).done(function(e,t,n){e=function(e){return e.filter(function(e){return e.status!=i.frozen&&e.status!=i.stashed})}(e[0].tasks),t=t[0],n=n[0];for(var a=e.map(e=>e.id),s=t.frozen||[],l=t.complete||[],d=0;d<l.length;d++)if(!(l[d].votes<2)){var u=a.indexOf(l[d].id);u>=0&&a.splice(u,1)}o(a,e.filter(e=>e.weight<3).map(e=>e.id)),o(a,s);var f=n.scythe[account.account.uid.toString()]||[];f=f.concat(n.admin[account.account.uid.toString()]||[]),o(a,f);var p=0,h="Scythe info for cell "+r+" (limit "+c+"):\n";if(h+="Your SC count: "+f.length+"\n",h+="Cubes you can SC: "+a.length+"\n",a.length>0)for(h+="List:\n ",d=0;d<a.length&&(h+="#"+a[d]+" ",++p!==c);d++);tomni.chat.addMsg({},h)}).fail(n))}}else tomni.chat.addMsg({},"You must be a scythe or higher to use this command.")}))}function d(){var e,t=[],n=[],a=this,o=$(".chatInput"),i=["(scouts)","(mystics)","(mods)","(mentors)","(admins)"],s=$("<div>").addClass("tabList").insertAfter(".chatInput");function d(e){var t=e.children(".userName").text(),n=0!==e.children(".userName").length,a=e.children(".dialogNobody").not(".tc-timestamp,.tc-msg-text").text().trim();return{username:t,hasUsername:n,scopeText:a,target:a.substring(1,a.length-1)}}function u(e){return e.includes(" earned ")&&e.includes(" points")||e.includes(" trailblazed a cube")||e.includes(" scythed a cube for")||e.includes(" scouted a cube for")}function f(){t.filter(function(e){return!e.isClosed()}).length>1?function(){let e=$(".chatInput");e.animate({bottom:"50px"},{complete:function(){s.fadeIn()}}),$(".chatMsgContainer").animate({bottom:50+e.outerHeight(!0)+"px"})}():s.fadeOut(function(){let e=$(".chatInput");e.animate({bottom:"10px"}),$(".chatMsgContainer").animate({bottom:10+e.outerHeight(!0)+"px"})})}function p(t,o){var s=t.username.toLowerCase(),r=t.hasUsername,c=t.scopeText,l=t.target.toLowerCase(),d=i.indexOf(c);if("All"===e.getName()){if(r&&c&&!a.prefs.get("tc-show-channels-in-all"))return!0;if(!a.prefs.get("tc-show-points-msgs"))if(u(o.find(".dialogNobody").text()))return!0;return!1}if("Commands"===e.getName()){var f=o.find(".dialogNobody").text();return!!(r||u(f)||function(e){return e.includes(" joined crew ")}(f))||o.find(".special,.generic").length>0}if(r){if(d>=0)return c!==e.getScope();if(!c&&a.prefs.get("tc-show-all-in-tabs")&&!e.isPMTab())return!1;if("(private)"===c&&e.getScope().toLowerCase()===s||n.indexOf(l)>=0&&e.getScope().toLowerCase()===l)return!1}return r||e.isPMTab()?!(o.find(".special").length>0&&!e.isPMTab()):u(o.find(".dialogNobody").text())}function h(){var t=[],n=[],o=[],i=[],s=a.prefs.get("tc-grayout-messages"),r="Commands"===e.getName();$(".chatMsg").each(function(){var e=d($(this));m($(this),e),p(e,$(this))?e.hasUsername&&s&&!r?(o.push($(this)),n.push($(this))):t.push($(this)):(e.hasUsername&&s&&i.push($(this)),n.push($(this)))}),$(t).map(function(){return this.toArray()}).hide(),$(n).map(function(){return this.toArray()}).show(),$(o).map(function(){return this.toArray()}).find(".tc-msg-text").addClass("dialogNobody"),$(i).map(function(){return this.toArray()}).find(".tc-msg-text").removeClass("dialogNobody"),$(".chatMsgContainer").scrollTop($(".chatMsgContainer")[0].scrollHeight)}function m(e,t){if(t.hasUsername){var n=e.find(".tc-timestamp");a.prefs.get("tc-show-timestamp")?n.show():n.hide()}}a.addTab=function(n,a,i){var c=new r({name:n,prefix:a,scope:i});return s.append(c.getElement()),c.getElement().on("click.tabbedChat",function(n){e!==c&&(e.setActive(!1),c.setActive(!0),c.setUnread(0),n.stopPropagation(),(!o.val().trim()||o.val().startsWith("/pm ")||t.findIndex(function(e){return o.val().trim()===e.getPrefix().trim()})>=0)&&o.val(c.getPrefix()),e=c,o.focus(),h(),$(".chatMsgContainer").scrollTop($(".chatMsgContainer")[0].scrollHeight))}),c.getElement().children("i").on("click.tabbedChat",function(e){c.close(),t[0].getElement().click(),e.stopPropagation(),f()}),t.push(c),f(),c},this.prefs=new c(function(){if(!a.prefs.get("tc-enable-unread"))for(var e=0;e<t.length;e++)t[e].setUnread(0);a.prefs.get("tc-grayout-messages")?$(".chatMsg").show():$(".chatMsg").find(".tc-msg-text").removeClass("dialogNobody");h()}),a.getActiveTab=function(){return e};var g=/&lt;([0-9]+)(,| |, )([0-9]+)(,| |, )([0-9]+)&gt;/g;function b(){let e=g.exec($(this).html());if(e){let t=parseInt(e[1],10),n=parseInt(e[3],10),a=parseInt(e[5],10);tomni.ui.recenterView(new THREE.Vector3(-t,-n,-a))}}function v(e){if(""===window.getSelection().toString()){e.preventDefault(),e.stopPropagation();var t=$(this).text().match(/^(t|task|tid)?#(\d+)$/i),n=parseInt(t[2],10);window.open(window.location.origin+"?tcJumpTaskId="+n)}}function w(e){$(this).addClass("clicked"),e.stopPropagation()}function C(){$("#charLeft").text(Math.max(0,180-$(".chatInput").val().length))}function y(n){if(n.ctrlKey&&(188===n.which||190===n.which)){n.preventDefault(),n.stopPropagation();var a=t.indexOf(e);if(188===n.which){for(a--;a>=0&&t[a].getElement().hasClass("disabled");)a--;a>=0&&t[a].getElement().click()}else if(190===n.which){for(a++;a<t.length&&t[a].getElement().hasClass("disabled");)a++;a<t.length&&t[a].getElement().click()}}}function k(){let e=ewdlc.account;e.isScythe()&&a.addTab("Commands","",""),e.isScout()&&a.addTab("Scouts","/gm scouts ","(scouts)"),e.isMystic()&&a.addTab("Mystics","/gm mystics ","(mystics)"),e.isModerator()&&a.addTab("Mods","/gm mods ","(mods)"),e.isMentor()&&a.addTab("Mentors","/gm mentors ","(mentors)"),e.isAdmin()&&a.addTab("Admins","/gm admins ","(admins)"),f()}(e=a.addTab("All","","")).setActive(!0),ewdlc&&ewdlc.account.isReady()?(a.commandProcessor=new l(a),k()):$(document).on("ewdlc-account-ready",function(){k(),a.commandProcessor=new l(a)}),o.focus(function(){h(),$("#charLeft").fadeIn(200)}).focusout(function(){$("#charLeft").fadeOut(200)}),$(".chatMsgContainer").bind("DOMNodeInserted",".chatMsg",function(){var s=$(this).children().last();if(s.find(".link.coords").on("click.tabbedChat",b),!(s.find(".tc-timestamp").length>0||s.find(".link.coords").length>0)){s.find(".taskid").on("click.tabbedChat",w).contextmenu(v);var r,c=d(s),l="";if(c.hasUsername&&(!function(e){var t=new Date,n=t.getHours().toString();1==n.length&&(n="0"+n);var a=t.getMinutes().toString();1==a.length&&(a="0"+a);var o=n+":"+a;$("<span>").addClass("dialogNobody").addClass("tc-timestamp").html(o+"&nbsp;").prependTo(e)}(s),s.find(".actualText").addClass("tc-msg-text")),m(s,c),function(e){var t,o=e.hasUsername,s=e.scopeText;if(o&&s){if("(private)"===s)t=e.username;else{if(!(i.indexOf(s)<0))return;t=s.substring(1,s.length-1)}n.indexOf(t.toLowerCase())<0&&(n.push(t.toLowerCase()),a.addTab(t,"/pm "+t+" ",t))}}(c),p(c,s)&&(c.hasUsername&&a.prefs.get("tc-grayout-messages")&&"Commands"!==e.getName()?s.find(".actualText").addClass("dialogNobody"):s.hide(),c.hasUsername)){var u="chat_public";s.find(".playerCallOut.me").length>0&&(u="chat_private"),i.indexOf(c.scopeText)>=0?l=c.scopeText:"(private)"===c.scopeText?(u="chat_private",l=c.username):n.indexOf(c.target)>=0&&(l=c.target),o.is(":focus")&&SFX.play(u),r=t.findIndex(function(e){return e.getScope()==l}),a.prefs.get("tc-enable-unread")&&t[r].setUnread(t[r].getUnread()+1)}"(private)"===c.scopeText?l=c.username:n.indexOf(c.target)>=0&&(l=c.target),r=t.findIndex(function(e){return e.getScope()==l}),t[r].open(),f(),o.removeClass("pulsing"),function(e){let t=e.html(),n=t.replace(g,function(e){return'<span class="link coords">'+e+"</span>"});n!==t&&(e.remove(),$("<div>").addClass("chatMsg").html(n).appendTo($(".chatMsgContainer")))}(s)}}),o.off("keydown").keydown(function(e){o.click(),e.ctrlKey&&y(e),e.keyCode===Keycodes.codes.shift||e.metaKey||e.ctrlKey||e.stopPropagation();var n=$(this).val();if(e.keyCode===Keycodes.codes.enter){(e.shiftKey||e.metaKey||e.ctrlKey)&&e.stopPropagation(),$(this).val(""),tomni.chat.history.locator=-1;var i=t.findIndex(function(e){return"All"!==e.getName()&&"Commands"!==e.getName()&&n.startsWith(e.getPrefix())});if(i>=0){var s=n.substring(t[i].getPrefix().length);if(s.startsWith("/"))return $(this).val(t[i].getPrefix()),"/help"===s.trim()?(tomni.chat.submitChatMessage(s),a.commandProcessor.exec(s),!1):!a.commandProcessor.exec(s)&&tomni.chat.submitChatMessage(s)}if(n.startsWith("/")||a.prefs.get("tc-allow-backslash-prefix")&&n.startsWith("\\")){if(n.startsWith("\\")&&(n="/"+n.substring(1)),"/help"===n.trim())return tomni.chat.submitChatMessage(n),a.commandProcessor.exec(n),!1;if(a.commandProcessor.exec(n))return!1}return tomni.chat.submitChatMessage(n)}return e.keyCode===Keycodes.codes.up?tomni.chat.history.up(this):e.keyCode!==Keycodes.codes.down||tomni.chat.history.down(this)}),o.on("keydown keypress",function(e){e.stopPropagation()}),$(document).on("keydown.tabbedChat",y);var x=function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");let n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null}("tcJumpTaskId");x&&($(".threeDPanel").on("cell-meshes-loaded.tabbedChat",function(){tomni.jumpToTaskID(parseInt(x,10)),$(this).off("cell-meshes-loaded.tabbedChat")}),history.replaceState({},"Cube Jump",window.location.origin)),$("<div>").addClass("charLeftContainer").insertAfter(".chatInput").append($("<span>").text("180").attr("id","charLeft").hide()),$(".chatInput").on("input.tabbedChat change.tabbedChat",C),setInterval(C,500)}function u(){var e=tomni.taskManager.ui.showLeaderboard;tomni.taskManager.ui.showLeaderboard=function(t){if(!ewdlc.modules.tabbedChat.prefs.get("tc-show-leaderboard"))return t.callback("proceed"),void $("#edit-cube-loader").css("opacity","0");e(t)}}function f(){function e(e,t,n){$("<div>").addClass("icon").attr("title",n).addClass(e).appendTo("#funStats"),$("<div>").attr("id",t).text("No Data").appendTo("#funStats")}var t;function n(){i.css("opacity","0"),setTimeout(function(){i.appendTo("#funStats"),i.css("visibility","hidden"),o.css("visibility","visible"),o.css("opacity","1"),t=setTimeout(a,1e4)},350)}function a(){o.css("opacity","0"),setTimeout(function(){o.appendTo("#funStats"),o.css("visibility","hidden"),i.css("visibility","visible"),i.css("opacity","1"),t=setTimeout(n,1e4)},350)}Profile.updateAlwaysVisibleStats=function(e){var t=function(e){return Utils.numberToCondensedSI({number:e,fit:6,maxchars:6,precision:0})};(e=e||{}).username&&"grimreaper"===e.username.toLowerCase()?($("#pointsValue").addClass("grimReaperPoints").html("&infin;"),$("#cubesValue").addClass("grimReaperPoints").html("&infin;"),$("#trailblazingsValue").addClass("grimReaperPoints").html("&infin;"),$("#funStats #scythedCubes").addClass("grimReaperPoints").html("&infin;"),$("#funStats #completedCubes").addClass("grimReaperPoints").html("&infin;")):($("#pointsValue").text(t(e.points)),$("#trailblazingsValue").text(t(e.trailblazes)),$("#cubesValue").text(t(e.cubes)),e.scythes&&$("#funStats #scythedCubes").text(t(e.scythes)),e.complete&&$("#funStats #completedCubes").text(t(e.complete))),$("#profileButton a").text(e.username)},tomni.taskManager.ui.modeSet=function(){$.getJSON("/1.0/player/"+encodeURIComponent(account.account.username)+"/stats",function(e){account.account.stats=e,Profile.updateAlwaysVisibleStats({username:account.account.username,points:e.forever.points,cubes:e.forever.cubes,trailblazes:e.forever.trailblazes,scythes:e.forever.scythes,complete:e.forever.complete})})};var o,i=$("#funStats div").slice(0,6),s=!0;function r(){$(window).width()>=1920?s||(s=!0,clearTimeout(t),i.css("visibility","visible"),i.css("opacity","1"),o&&(o.appendTo($("#funStats")),o.css("visibility","visible"),o.css("opacity","1"))):s&&(s=!1,o&&(t=setTimeout(n,1e4),o.css("visibility","hidden"),o.css("opacity","0")))}account.refresh=function(e){return $.getJSON("/1.0/player/describe/").done(function(t){t&&t.id&&(account.account.username=t.username,account.account.uid=t.id,account.account.rank=t.class,account.account.joined=new Date(t.joined),account.account.country=t.country,account.account.country_name=t.country_name,account.account.trained=t.trained,account.account.newbie=t.newbie,account.account.first_timer=t.first_timer,account.account.language=t.language,account.account.level=t.level||0,account.assignRoles(t),$.getJSON("/1.0/player/"+account.account.username+"/stats",function(e){Profile.updateAlwaysVisibleStats({username:t.username,points:e.forever.points,cubes:e.forever.cubes,trailblazes:e.forever.trailblazes,scythes:e.forever.scythes,complete:e.forever.complete}),account.account.stats=e}),$("#acc").html($("#logoutButtons").html()),e&&e.call(this),$(document).trigger("account-info-ready",[account]))})},$(document).on("ewdlc-account-ready",function(){ewdlc.account.isScout()&&(e("scytheIcon","scythedCubes","Cubes Scythed"),o=$("#funStats div").slice(6,8)),ewdlc.account.isScythe()&&(e("completedCubesIcon","completedCubes","Cubes Completed"),o=$("#funStats div").slice(6,10)),r(),account.refresh()}),$(document).resize(r)}function p(){var e=new t("tc-enlarge-reap-buttons",!1,!1),n=new t("tc-swap-moveon-flag",!1,!1),a=$.Deferred(),o=$.Deferred();function i(e,t){$(".reapAuxButton").toggleClass("tcEnlargeButtons",t),$("#editActions").toggleClass("tcEnlargeButtons",t)}function s(t,n){var a=$("#flagCube"),o=$("#actionInspectReviewContinue");n?(a.insertAfter($("#deselectSeedGT")).addClass("reapAuxButton enabled tcFlagSwapped").removeClass("reaperButton").empty(),o.insertAfter($("#saveGT")).addClass("reaperButton tcFlagSwapped").removeClass("reapAuxButton enabled").text("Move On"),$("<i>").addClass("fa fa-flag-o").appendTo(a)):(a.insertAfter($("#saveGT")).addClass("reaperButton").removeClass("reapAuxButton enabled tcFlagSwapped").empty().text("Flag"),o.insertAfter($("#deselectSeedGT")).addClass("reapAuxButton enabled").removeClass("reaperButton tcFlagSwapped").empty()),i(0,e.getValue())}$(document).on("ewdlc-account-ready",function(){!function(){if(!ewdlc.account.isMystic())return;let e=$("#jumpContainer").clone().detach(),t=e.find("input"),n=e.find("button");e.css("margin-left","8px"),t.attr("placeholder","Enter Cell #"),t.attr("id","cellJumpField"),n.attr("disabled","true"),n.attr("id","cellJumpButton"),t.ion("keydown keypress",function(e){e.stopPropagation()}),n.click(function(e){e.preventDefault();var n=t.removeClass("error"),a=parseInt(n.val(),10);return isNaN(a)?(n.addClass("error"),!1):(tomni.setCell({id:a}).fail(function(){n.addClass("error")}),!1)}),t.ion("change keyup input",function(e){e.stopPropagation(),n.prop("disabled",0===$(this).val().length),e.keyCode!==Keycodes.codes.enter?$(this).removeClass("error"):n.click()}),e.appendTo("#cubeFinder")}(),$("<div>").attr("title","Decrease brush size (q)").addClass("fob brush dec").click(function(e){e.stopPropagation(),SFX.play("button"),tomni.prefs.decreaseBrushSize()}).insertAfter($("#mst-slider-container")),$("<div>").attr("title","Increase brush size (e)").addClass("fob brush inc").click(function(e){e.stopPropagation(),SFX.play("button"),tomni.prefs.increaseBrushSize()}).insertAfter($("#mst-slider-container")),function(){var e=$("#twoD"),t=$("<div>").addClass("twoD-borders").hide().insertAfter(e),n=t.get(0),a=e.get(0);new MutationObserver(function(e){e.forEach(function(e){if("attributes"===e.type&&"style"===e.attributeName){var t=a.getAttribute("style"),o=t.indexOf("transform"),i=n.getAttribute("style"),s=i.indexOf("transform");if(o>=0){var r=t.substring(o,t.indexOf(";",o)+1),c=i.substring(s,i.indexOf(";",s)+1);s>=0?n.setAttribute("style",i.replace(c,r)):n.setAttribute("style",i+r)}}})}).observe(e.get(0),{attributes:!0});var o=$("<div>").attr("title","Toggle spawn borders (b)").addClass("fob").text("SB").click(function(e){e.stopPropagation(),SFX.play("button"),t.toggle()}).appendTo($(".twoD-controls")),i=!0,s=tomni.play;tomni.play=function(e){1!==tomni.getCurrentCell().info.dataset_id?o.hide():o.show(),i?(setTimeout(function(){t.hide()},500),i=!1):t.hide(),s(e)},$(document).on("keydown.spawnBorders",function(e){tomni.gameMode&&1===tomni.getCurrentCell().info.dataset_id&&e.keyCode===Keycodes.codes.b&&(e.preventDefault(),SFX.play("button"),t.toggle())})}(),a.resolve()}),$(document).on("ewdlc-preferences-loading.extraControls",function(){ewdlc.preferences.registerSetting(e),ewdlc.preferences.registerSetting(n),e.registerCallback(i)}),$(document).on("ewdlc-preferences-loaded.extraControls",function(){o.resolve()}),$.when(a,o).then(function(){ewdlc.account.isScout()&&ewdlc.settingsUi.makeCheckbox(e,"Enlarge in-cube buttons"),!ewdlc.account.isScythe()&&ewdlc.account.isScout()&&(n.registerCallback(s),ewdlc.settingsUi.makeCheckbox(n,"Swap move on/flag buttons"),s(0,n.getValue()))})}function h(){var e=$("#cubeInspectorFloatingControls"),n=new MutationObserver(function(e){e.forEach(function(e){"attributes"===e.type&&"style"===e.attributeName&&c()})}),a=new t("uibox-top",null,null),o=new t("uibox-left",null,null),i=new t("uibox-cube-tab",!1,!1);function s(e,t,n){return Math.max(t,Math.min(e,n))}function r(t,i){(function(t,a){n.disconnect(),e.css("top",t+"px"),e.css("left",a+"px"),n.observe(document.getElementById("cubeInspectorFloatingControls"),{attributes:!0})})(t=s(t,0,$(document).height()-e.outerHeight()),i=s(i,0,$(document).width()-e.outerWidth())),a.setValue(t),o.setValue(i)}function c(){var t=e.css("top"),n=e.css("left");"auto"===t||"auto"===n||n.includes("%")||r(d(t),d(n))}function l(e){e.addClass("tc");var t=new MutationObserver(function(n){n.forEach(function(n){if(0!=n.addedNodes.length){var a=$(n.target);e.children(".link").length>0||function(e,t){var n=e.text();if("-"!==n){e.empty();for(var a=n.split(", "),o=0;o<a.length;o++){var i=$("<span>").addClass("link"),s=parseInt(a[o],10);i.text(a[o]),i.data("target",s),i.click(function(e){$(this).addClass("clicked"),tomni.jumpToTaskID($(this).data("target")),e.stopPropagation()}),e.append(i),o<a.length-1&&e.append(", ")}t.takeRecords()}}(a,t)}})});t.observe(e[0],{childList:!0,characterData:!0})}function d(e){return parseInt(e.replace("px","").trim(),10)}$(document).on("ewdlc-preferences-loading",function(){ewdlc.preferences.registerSetting(a),ewdlc.preferences.registerSetting(o),ewdlc.preferences.registerSetting(i)}),$(document).on("ewdlc-preferences-loaded",function(){null!=a.getValue()&&null!=o.getValue()&&r(a.getValue(),o.getValue());var t=e.find(".info > .cube.minimalButton");i.getValue()?t.click():e.find(".info > .player.minimalButton").click(),new MutationObserver(function(e){e.forEach(function(e){"attributes"===e.type&&"class"===e.attributeName&&i.setValue(t.hasClass("selected"))})}).observe(t.get(0),{attributes:!0}),n.observe(document.getElementById("cubeInspectorFloatingControls"),{attributes:!0}),$(document).resize(function(){c()})});var u=setInterval(function(){0!=e.length?(e.find("div.panel.player.selected").bind("DOMNodeInserted","li",function(){let e,t=$(this).children().last(),n=t.text();t.hasClass("admin")?e=Cell.ScytheVisionColors.reap:t.hasClass("scythe")?e=Cell.ScytheVisionColors.scythed:t.hasClass("complete")?e=Cell.ScytheVisionColors.complete2:t.hasClass("scout")&&(e=Cell.ScytheVisionColors.review),e&&t.css("color",e),"No Cube Selected"!==n&&t.on("click.floatinsp",function(){Profile.show({username:n})})}),l(e.find(".panel.cube > .parent_task > .value")),l(e.find(".panel.cube > .child_tasks > .value")),clearInterval(u)):e=$("#cubeInspectorFloatingControls")},500)}function m(){function e(e,t){$(e).each(function(){this.style.setProperty("color",t,"important")})}var t=setInterval(function(){document.getElementById("slPanel")&&(document.getElementById("slPanel").addEventListener("keypress",function(e){e.stopPropagation()}),console.log("Fixed Scouts' Log Review button bug."),clearInterval(t),e(".sl-need-admin",Cell.ScytheVisionColors.reap),e(".sl-need-scythe",Cell.ScytheVisionColors.scythed))},1e3)}function g(e){var t,n,a,o,i,s,r=this,c=!1,l=!1,d=!1,u={},f={},p={},h=[{key:"complete1",lang:"1 SC Vote"},{key:"complete2",lang:"2 SC Votes"},{key:"complete3",lang:"Admin SC"},{key:"review",lang:"Review"},{key:"scythed",lang:"Scythed"},{key:"reap",lang:"Reaped"},{key:"frozen",lang:"Frozen"},{key:"duplicate",lang:"Duplicate"},{key:"base",lang:"Base"}];function m(e,t){return $("<div>").addClass("minimalButton").attr("id","prvw-action").text(t).appendTo(e)}function g(e){let n=$("<div>").attr("id","prvw-colors").appendTo(e),r=$("<div>").attr("id","prvw-actions").appendTo(e);!function(e){for(var n=0;n<h.length;n++){let a=$("<div>").attr("id","prvw-color").text(h[n].lang),o=h[n].key,i=$("<input>").attr("type","text").appendTo(a);i.spectrum({showInitial:!0,showInput:!0,preferredFormat:"hex",replacerClassName:"prvw-spectrum",move:function(e){p[o]=e.toHexString(),t.trigger("prvw-colors-changed")}}),a.appendTo(e),u[h[n].key]=i}}(n),a=m(r,"Save"),o=m(r,"Discard"),i=m(r,"Default"),s=m(r,"Exit Preview"),$("<div>").css("padding-left","10px").css("padding-bottom","5px").text("Note: Saved changes will take effect only after refreshing.").appendTo(e)}function b(){t=$("<div>").attr("id","prvw-container");let e=$("<div>").attr("id","prvw-top").appendTo(t),a=$("<div>").appendTo(t);g(e),function(e){n=$("<div>").attr("id","prvw-collapse").text("Preview Mode!").appendTo(e)}(a),t.appendTo($(".gameBoard"))}r.init=function(){c||(b(),n.click(function(e){if(e.stopPropagation(),d)return;let a={duration:600,queue:!1};if(l)t.animate({top:0},a),l=!1;else{let e=t.outerHeight()-n.outerHeight()+1;t.animate({top:-e},a),l=!0}}),t.on("keyup keydown keypress",function(e){e.stopPropagation()}),$(".sp-container").on("keyup keydown keypress",function(e){e.stopPropagation()}),o.on("click",function(e){e.stopPropagation(),r.setColors(f)}),a.on("click",function(e){e.stopPropagation(),f=$.extend({},p),t.trigger("prvw-colors-saved")}),i.on("click",function(t){t.stopPropagation();let n=$.extend({},f);r.setColors(e),f=n}),s.on("click",function(e){if(e.stopPropagation(),d)return;let n={duration:600,queue:!1,complete:function(){d&&t.hide()}};d=!0,t.animate({top:-t.outerHeight()},n),t.trigger("prvw-exited")}),t.css("top",-t.outerHeight()+"px"),t.hide(),d=!0,c=!0)},r.getColors=function(){return $.extend({},p)},r.setColors=function(e){if(c){e=e||{};for(let t in e)u[t]&&(u[t].spectrum("set",e[t]),f[t]=e[t],p[t]=e[t]);t.trigger("prvw-colors-changed")}},r.getContainer=function(){return t},r.show=function(){if(!d)return;d=!1,l=!1;t.show(),t.animate({top:0},{duration:600,queue:!1})}}function b(){var e,n,a,o,i,s,r,c,l,d=null,u=new t("prvw-colors",$.extend({},Cell.ScytheVisionColors)),f=[],p=$.Deferred(),h=$.Deferred(),m=$.Deferred();function b(){a&&a.abort(),o&&o.abort(),e=[],n={},r=tomni.getCurrentCell(),c=r.resetTaskColors,l=r.updateCompleteColoring,r.resetTaskColors=function(){},r.updateCompleteColoring=function(){},f=r.info.tags.ReapGrow?["scythed","complete1","complete2","complete3","review","reap","duplicate","frozen"]:["complete1","complete2","complete3","review","scythed","reap","duplicate","frozen"],s=!0,d.show(),i=!1,a=$.getJSON("/1.0/cell/"+tomni.cell+"/tasks").done(y),o=$.getJSON("/1.0/cell/"+tomni.cell+"/heatmap/scythe").done(k),$.when(a,o).done(function(){i=!0,C()})}function v(){s=!1,a&&a.abort(),o&&o.abort(),a=null,o=null,r&&(r.updateCompleteColoring=l,r.resetTaskColors=c,r.resetTaskColors({hard:!0})),c=null,r=null,e=null,n=null,f=null,i=!1}function w(){u.setValue($.extend({},u.getValue(),d.getColors()))}function C(){if(s&&i){var t=d.getColors();r.colorCubes({cubeids:e,color:ColorUtils.hexToRGB(t.base),blending:1});for(var a=0;a<f.length;a++)r.colorCubes({cubeids:n[f[a]],color:ColorUtils.hexToRGB(t[f[a]]),blending:1});r.render()}}function y(t){e=t.tasks.map(e=>e.id)}function k(e){n.scythed=e.scythed,n.reap=e.reaped,n.complete1=e.complete.filter(e=>1==e.votes).map(e=>e.id),n.complete2=e.complete.filter(e=>2==e.votes).map(e=>e.id),n.complete3=e.complete.filter(e=>e.votes>=1e6).map(e=>e.id),n.review=e.review,n.frozen=e.frozen,n.duplicate=e.duplicate}jQuery.cachedScript=function(e,t){return t=$.extend(t||{},{dataType:"script",cache:!0,url:e}),jQuery.ajax(t)},$("<link>").attr("rel","stylesheet").attr("href","https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.0/spectrum.min.css").appendTo($("head")),$.cachedScript("https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.0/spectrum.min.js").done(m.resolve),this.getView=function(){return d},$(document).on("ewdlc-account-ready",p.resolve),$(document).on("ewdlc-preferences-loaded.cellColorPicker",h.resolve),$.when(p,h,m).then(function(){if(!ewdlc.account.isScout())return;(d=new g($.extend({},Cell.ScytheVisionColors))).init(),d.setColors($.extend({},u.getValue()));let e=d.getContainer();e.on("prvw-exited.cellColorPicker",v),e.on("prvw-colors-changed.cellColorPicker",C),e.on("prvw-colors-saved.cellColorPicker",w),ewdlc.settingsUi.makeButton("Show Cell Color Picker").click(b)}),$(document).on("ewdlc-preferences-loading.cellColorPicker",function(){ewdlc.preferences.registerSetting(u)}),$(document).on("ewdlc-preferences-loaded.cellColorPicker",function(){Cell.ScytheVisionColors=u.getValue()})}function v(){var e,t=$("#profileJoinedDate span"),n=$("#profileContainer #profUsername");(e=new MutationObserver(function(a){a.forEach(function(a){var o;0!==a.addedNodes.length&&(t.children("span").length>0||(o=n.text(),$.getJSON("/1.0/player/"+o+"/bio").done(function(n){var a=moment(1e3*n.joined),o=moment(),i=a.fromNow(),s=$("<span>").text(" ("+i+")"),r=o.diff(a,"years");o.add(-r,"years");var c=o.diff(a,"months");o.add(-c,"months");var l=o.diff(a,"days"),d=[];r>0&&d.push(r+"y"),c>0&&d.push(c+"m"),l>0&&d.push(l+"d"),d.length>0&&s.attr("title",d.join(", ")+" ago"),t.append(s.hide().fadeIn()),e.takeRecords()})))})})).observe(t[0],{childList:!0,characterData:!0})}var w={TabbedChat:Object.freeze({TabbedChatInit:function(){$("<link>").attr("rel","stylesheet").attr("type","text/css").attr("href",ewdlc.getResourceUrl("/css/ewdlc.min.css")).appendTo("head");var e=setInterval(function(){for(var t=!1,n=0;n<document.styleSheets.length;n++)document.styleSheets[n].href&&document.styleSheets[n].href.includes("/css/ewdlc.min.css")&&(t=!0);t&&($(".chatInput").trigger("keyup"),clearInterval(e))},500);$("<script>",{src:"https://use.fontawesome.com/7745d29f5b.js"}).appendTo("body"),ewdlc.modules.tabbedChat=ewdlc.modules.tabbedChat||new d},TabbedChat:d,Tab:r,TabbedPrefs:c}),SkippableLeaderboard:Object.freeze({SkippableLeaderboard:u,SkippableLeaderboardInit:function(){ewdlc.modules.skippableLeaderboard=ewdlc.modules.skippableLeaderboard||new u}}),ExtraStats:Object.freeze({ExtraStats:f,ExtraStatsInit:function(){ewdlc.modules.extraStats=ewdlc.modules.extraStats||new f}}),ExtraControls:Object.freeze({ExtraControls:p,ExtraControlsInit:function(){ewdlc.modules.extraControls=ewdlc.modules.extraControls||new p}}),UiBoxImprovements:Object.freeze({UiBoxImprovements:h,UiBoxImprovementsInit:function(){ewdlc.modules.uiBoxImprovements=ewdlc.modules.uiBoxImprovements||new h}}),SlHacks:Object.freeze({SlHacks:m,SlHacksInit:function(){ewdlc.modules.slHacks=ewdlc.modules.slHacks||new m}}),CellColorPicker:Object.freeze({CellColorPickerInit:function(){ewdlc.modules.cellColorPicker=ewdlc.modules.cellColorPicker||new b},CellColorPicker:b}),ProfileWindowChanges:Object.freeze({ProfileWindowChangesInit:function(){ewdlc.modules.profileWindowChanges=ewdlc.modules.profileWindowChanges||new v,$("body").append('<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js" integrity="sha256-ABVkpwb9K9PxubvRrHMkk6wmWcIHUE9eBxNZLXYQ84k=" crossorigin="anonymous"><\/script>')},ProfileWindowChanges:v})};return $(document).ready(function(){if(0==$(".gameBoard").length)return;let e=e||new s("https://crazyman4865.com/eyewire/static");!function(){for(var e in w)w[e][e+"Init"]()}(),e.init()}),e.Modules=w,e.EWDLC=s,e.Preferences=n,e.Account=a,e.Setting=t,e.SettingsUi=o,e.TaskStatus=i,e}({});
//# sourceMappingURL=ewdlc.min.js.map